<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h4 class="mb-0">Kategori Yönetimi</h4>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a href="/dashboard">Ana Sayfa</a></li>
                <li class="breadcrumb-item active" aria-current="page">Kategoriler</li>
            </ol>
        </nav>
    </div>
    <div class="d-flex gap-2">
        <button class="btn btn-outline-secondary" id="refreshCategories">
            <i class="bi bi-arrow-repeat me-1"></i> Yenile
        </button>
        <button class="btn btn-primary" id="addCategoryBtn">
            <i class="bi bi-plus-lg me-1"></i> Yeni Kategori
        </button>
    </div>
</div>

<div class="card">
    <div class="card-header bg-white border-0 pb-0">
        <div class="row g-3 align-items-center">
            <div class="col-lg-6">
                <label class="form-label text-muted small mb-1">Arama</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control" id="categorySearch" placeholder="Kategori veya alt kategori adı...">
                </div>
            </div>
            <div class="col-lg-3">
                <div class="form-check form-switch mt-4 pt-1">
                    <input class="form-check-input" type="checkbox" id="showInactiveOnly">
                    <label class="form-check-label" for="showInactiveOnly">
                        Sadece pasif kategorileri göster
                    </label>
                </div>
            </div>
            <div class="col-lg-3 text-lg-end">
                <span class="text-muted small">
                    Toplam <span class="fw-semibold" id="categoryCount">0</span> kategori
                </span>
            </div>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0" id="categoriesTable">
                <thead class="table-light">
                    <tr>
                        <th>Kategori</th>
                        <th>Alt Kategoriler</th>
                        <th class="text-center">Alt Kategori Adedi</th>
                        <th>Durum</th>
                        <th class="text-end">İşlemler</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="5" class="text-center text-muted py-4">
                            Kategoriler yükleniyor...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="categoryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Kategori</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="categoryForm">
                <div class="mb-3">
                    <label class="form-label">Kategori Adı</label>
                    <input type="text" class="form-control" name="name" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Alt Kategoriler</label>
                    <textarea class="form-control" name="subcategories" rows="5" placeholder="Her satıra bir alt kategori yazın (örn: Elbise, Tişört, Çocuk)"></textarea>
                    <div class="form-text">Alt kategoriler isteğe bağlıdır. Her kategori için sınırsız sayıda alt kategori ekleyebilirsiniz.</div>
                </div>
                <div class="form-check form-switch mb-2">
                    <input class="form-check-input" type="checkbox" name="isActive" checked>
                    <label class="form-check-label">Aktif</label>
                </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">İptal</button>
                <button type="button" class="btn btn-primary" id="saveCategoryBtn">
                    <i class="bi bi-save me-1"></i> Kaydet
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    if (typeof bootstrap === 'undefined') return;

    const tableBody = document.querySelector('#categoriesTable tbody');
    const categoryCountEl = document.getElementById('categoryCount');
    const searchInput = document.getElementById('categorySearch');
    const showInactiveOnlySwitch = document.getElementById('showInactiveOnly');
    const refreshBtn = document.getElementById('refreshCategories');
    const addBtn = document.getElementById('addCategoryBtn');
    const saveBtn = document.getElementById('saveCategoryBtn');
    const modalElement = document.getElementById('categoryModal');
    const modal = new bootstrap.Modal(modalElement);
    const form = document.getElementById('categoryForm');
    const nameInput = form.querySelector('[name="name"]');
    const subcategoriesInput = form.querySelector('[name="subcategories"]');
    const isActiveInput = form.querySelector('[name="isActive"]');

    let categories = [];
    let currentId = null;

    function showAlert(message, type = 'success') {
        const alert = document.createElement('div');
        alert.className = `alert alert-${type} alert-dismissible fade show`;
        alert.role = 'alert';
        alert.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        document.querySelector('.main-content').prepend(alert);
        setTimeout(() => alert.remove(), 4000);
    }

    function escapeHtml(text) {
        return String(text ?? '').replace(/[&<>"']/g, (char) => {
            switch (char) {
                case '&': return '&amp;';
                case '<': return '&lt;';
                case '>': return '&gt;';
                case '"': return '&quot;';
                case '\'': return '&#39;';
                default: return char;
            }
        });
    }

    function parseLines(text = '') {
        return text
            .split(/\r?\n/)
            .map(item => item.trim())
            .filter(Boolean);
    }

    function normalizeSubcategoryList(value) {
        if (Array.isArray(value)) {
            return value
                .map(item => String(item ?? '').trim())
                .filter(Boolean);
        }
        if (value === undefined || value === null) {
            return [];
        }
        if (typeof value === 'object') {
            return Object.values(value)
                .map(item => String(item ?? '').trim())
                .filter(Boolean);
        }
        return parseLines(String(value));
    }

    function normalizeCategory(record = {}) {
        return {
            id: record.id,
            name: record.name || '',
            subcategories: normalizeSubcategoryList(record.subcategories),
            isActive: record.isActive !== undefined ? !!record.isActive : true
        };
    }

    function renderBadgeList(list, emptyText) {
        if (!Array.isArray(list) || !list.length) {
            return `<span class="text-muted">${emptyText}</span>`;
        }
        return list
            .map(item => `<span class="badge bg-light text-dark me-1 mb-1">${escapeHtml(item)}</span>`)
            .join('');
    }

    function renderTable() {
        const query = searchInput.value.trim().toLowerCase();
        const showInactiveOnly = showInactiveOnlySwitch.checked;

        const filtered = categories.filter(category => {
            if (showInactiveOnly) {
                if (category.isActive) return false;
            } else if (!category.isActive) {
                return false;
            }
            if (!query) return true;
            const haystack = [category.name, ...category.subcategories].join(' ').toLowerCase();
            return haystack.includes(query);
        });

        categoryCountEl.textContent = filtered.length.toString();

        if (!filtered.length) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center text-muted py-4">Kategori bulunamadı.</td>
                </tr>
            `;
            return;
        }

        tableBody.innerHTML = filtered.map(category => {
            const displayName = category.name
                ? `<div class="fw-semibold">${escapeHtml(category.name)}</div>`
                : '<span class="text-muted">-</span>';
            const statusClass = category.isActive ? 'badge bg-success bg-opacity-10 text-success' : 'badge bg-secondary';
            const statusText = category.isActive ? 'Aktif' : 'Pasif';
            return `
                <tr data-id="${category.id}">
                    <td>${displayName}</td>
                    <td>${renderBadgeList(category.subcategories, 'Alt kategori yok')}</td>
                    <td class="text-center">${category.subcategories.length}</td>
                    <td><span class="${statusClass}">${statusText}</span></td>
                    <td class="text-end">
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" data-action="edit">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-outline-secondary" data-action="toggle">
                                <i class="bi ${category.isActive ? 'bi-pause-circle' : 'bi-play-circle'}"></i>
                            </button>
                            <button class="btn btn-outline-danger" data-action="delete">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    }

    async function loadCategories() {
        try {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center text-muted py-4">Yükleniyor...</td>
                </tr>
            `;
            const response = await fetch('/api/categories?includeInactive=true');
            if (!response.ok) {
                throw new Error('Kategoriler getirilemedi');
            }
            const data = await response.json();
            categories = Array.isArray(data) ? data.map(normalizeCategory) : [];
            renderTable();
        } catch (error) {
            console.error(error);
            showAlert(error.message || 'Beklenmeyen bir hata oluştu', 'danger');
        }
    }

    function resetForm() {
        currentId = null;
        form.reset();
        isActiveInput.checked = true;
        subcategoriesInput.value = '';
        setTimeout(() => nameInput.focus(), 150);
    }

    function populateForm(category) {
        currentId = category.id;
        nameInput.value = category.name || '';
        subcategoriesInput.value = category.subcategories.join('\n');
        isActiveInput.checked = !!category.isActive;
        setTimeout(() => nameInput.focus(), 150);
    }

    async function submitForm() {
        try {
            const name = nameInput.value.trim();
            const subcategories = parseLines(subcategoriesInput.value);
            const isActive = isActiveInput.checked;

            if (!name) {
                showAlert('Kategori adı zorunludur.', 'warning');
                return;
            }

            const payload = { name, subcategories, isActive };
            const endpoint = currentId ? `/api/categories/${currentId}` : '/api/categories';
            const method = currentId ? 'PUT' : 'POST';

            const response = await fetch(endpoint, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                let result = {};
                try {
                    result = await response.json();
                } catch (parseError) {
                    // ignore
                }
                throw new Error(result.details || result.error || 'Kayıt sırasında hata oluştu');
            }

            modal.hide();
            showAlert('Kategori kaydedildi');
            await loadCategories();
        } catch (error) {
            console.error(error);
            showAlert(error.message || 'Kategori kaydedilirken hata oluştu', 'danger');
        }
    }

    async function toggleCategory(id) {
        const category = categories.find(item => item.id === id);
        if (!category) return;

        try {
            const response = await fetch(`/api/categories/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ isActive: !category.isActive })
            });
            if (!response.ok) {
                let result = {};
                try {
                    result = await response.json();
                } catch (parseError) {
                    // ignore
                }
                throw new Error(result.details || result.error || 'Durum güncellenemedi');
            }
            showAlert('Kategori durumu güncellendi');
            await loadCategories();
        } catch (error) {
            console.error(error);
            showAlert(error.message || 'Durum güncellenirken hata oluştu', 'danger');
        }
    }

    async function deleteCategory(id) {
        if (!confirm('Bu kategoriyi silmek istiyor musunuz?')) return;
        try {
            const response = await fetch(`/api/categories/${id}`, { method: 'DELETE' });
            if (!response.ok) {
                let result = {};
                try {
                    result = await response.json();
                } catch (parseError) {
                    // ignore
                }
                throw new Error(result.details || result.error || 'Kategori silinemedi');
            }
            showAlert('Kategori silindi');
            await loadCategories();
        } catch (error) {
            console.error(error);
            showAlert(error.message || 'Kategori silinirken hata oluştu', 'danger');
        }
    }

    tableBody.addEventListener('click', (event) => {
        const button = event.target.closest('[data-action]');
        if (!button) return;

        const row = button.closest('tr');
        const id = Number(row.dataset.id);
        const category = categories.find(item => item.id === id);
        if (!category) return;

        if (button.dataset.action === 'edit') {
            resetForm();
            populateForm(category);
            modal.show();
            return;
        }

        if (button.dataset.action === 'toggle') {
            toggleCategory(id);
            return;
        }

        if (button.dataset.action === 'delete') {
            deleteCategory(id);
            return;
        }
    });

    addBtn.addEventListener('click', () => {
        resetForm();
        modal.show();
    });

    saveBtn.addEventListener('click', submitForm);
    form.addEventListener('submit', (event) => {
        event.preventDefault();
        submitForm();
    });

    searchInput.addEventListener('input', renderTable);
    showInactiveOnlySwitch.addEventListener('change', renderTable);
    refreshBtn.addEventListener('click', loadCategories);

    modalElement.addEventListener('shown.bs.modal', () => {
        nameInput.focus();
    });

    loadCategories();
});
</script>

